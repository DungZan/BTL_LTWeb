@model BTL_LTWeb.ViewModels.CheckoutViewModel
@{
    ViewData["Title"] = "Thanh toán";
    Layout = "~/Views/Shared/_PayLayout.cshtml";
    int i = 0;
    var diaChiParts = Model.CustomerInfo.DiaChi.Split(",");
    var diaChi = string.Join(", ", diaChiParts.Take(diaChiParts.Length - 2).Select(part => part.Trim()));
}


<style>
    #h2td{
        text-align:center;
    }
</style>
<h2 id="h2td">Thông tin Thanh toán</h2>

<div class="site-section">
    <div class="container">
        <form asp-controller="Pay" asp-action="ProcessPayment" method="post">
        <div class="row">
                <input type="hidden" class="form-control" value="@Model.CustomerInfo.MaKhachHang" id="id" name="MaKhachHang">
            <div class="col-md-6 mb-5 mb-md-0">
                <h2 class="h3 mb-3 text-black">Thông tin khách hàng</h2>
                <div class="p-3 p-lg-5 border">
                    <div class="form-group">
                        <label for="c_city" class="text-black">Thành phố(Tỉnh)<span class="text-danger">*</span></label>
                        <input type="text" id="c_city" name="ThanhPho" class="form-control" value="@Model.CustomerInfo.DiaChi.Split(",").Last().Trim()" readonly />
                    </div>

                    <div class="form-group">
                        <label for="c_district" class="text-black">Quận (Huyện)<span class="text-danger">*</span></label>
                        <input type="text" id="c_district" name="QuanHuyen" class="form-control" value="@Model.CustomerInfo.DiaChi.Split(",")[^2].Trim()" readonly />
                    </div>

                    <div class="form-group row">
                        <div class="col-md-12">
                            <label for="c_fname" class="text-black">Họ Và Tên<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" value="@Model.CustomerInfo.TenKhachHang" id="c_fname" name="HoTen" readonly>
                        </div>
                    </div>
                        
                    <div class="form-group row">
                        <div class="col-md-12">
                                <label for="c_address" class="text-black">Số nhà, Ngõ, Xã/Phường<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" value="@diaChi" id="c_address" name="DiaChi" placeholder="Nhập Số nhà, Ngõ, Xã/Phường" readonly>
                        </div>
                    </div>
                    <div class="form-group row mb-5">
                        <div class="col-md-6">
                            <label for="c_email_address" class="text-black">Email<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" value="@Model.CustomerInfo.Email" readonly>
                        </div>
                        <div class="col-md-6">
                            <label for="c_phone" class="text-black">Số Điện Thoại<span class="text-danger">*</span></label>
                                <input type="text" class="form-control" value="@Model.CustomerInfo.SoDienThoai" id="c_phone" name="SDT" placeholder="Nhập Số Điện Thoại" readonly>
                        </div>
                    </div>

                    <div class="form-group">
                            <label for="c_ship_different_address" class="text-black" data-toggle="collapse" href="#ship_different_address" role="button" aria-expanded="false" aria-controls="ship_different_address"><input type="checkbox" value="1" id="c_ship_different_address" name="GiaoHangDiaChiKhac"> Giao hàng ở địa chỉ khác?</label>
                        <div class="collapse" id="ship_different_address">
                            <div class="py-2">

                                <div class="form-group">
                                    <label for="c_country" class="text-black">Thành Phố(Tỉnh)<span class="text-danger">*</span></label>
                                        <select id="c_diff_country" class="form-control" onchange="updateProvinceName()">
                                        <option value="">Chọn Thành Phố(Tỉnh)</option>
                                    </select>
                                </div>
                                    <input type="hidden" class="form-control" id="ten_thanh_pho" name="ThanhPhoKhac">
                                <div class="form-group">
                                    <label for="c_district" class="text-black">Quận (Huyện)<span class="text-danger">*</span></label>
                                        <select id="c_diff_district" class="form-control" onchange="updateDistrictName()">
                                        <option value="">Chọn Quận (Huyện)</option>
                                    </select>
                                </div>
                                    <input class="form-control" id="ten_quan_huyen" name="QuanHuyenKhac">
                                <div class="form-group row">
                                    <div class="col-md-12">
                                        <label for="c_diff_fname" class="text-black">Họ Và Tên<span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="c_diff_fname" name="HoTenKhac">
                                    </div>
                                </div>

                                <div class="form-group row">
                                    <div class="col-md-12">
                                            <label for="c_address" class="text-black">Số nhà, Ngõ, Xã/Phường<span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="c_diff_address" name="DiaChiKhac" placeholder="Nhập Số nhà, Ngõ, Xã/Phường">
                                    </div>
                                </div>

                                <div class="form-group row mb-5">
                                   
                                    <div class="col-md-12">
                                        <label for="c_diff_phone" class="text-black">Số Điện Thoại <span class="text-danger">*</span></label>
                                            <input type="text" class="form-control" id="c_diff_phone" name="SDTKhac" placeholder="Nhập Số Điện Thoại">
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="c_order_notes" class="text-black">Ghi chú</label>
                            <textarea id="c_order_notes" name="GhiChu" cols="30" rows="5" class="form-control" placeholder="Viết ghi chú vào đây ..."></textarea>
                    </div>

                </div>
            </div>
            <div class="col-md-6">

                <div class="row mb-5">
                    <div class="col-md-12">
                        <h2 class="h3 mb-3 text-black">Mã Giảm Giá</h2>
                        <div class="p-3 p-lg-5 border">

                            <label for="c_code" class="text-black mb-3">Nhập mã phiếu giảm giá của bạn nếu bạn có</label>
                            <div class="input-group w-75">
                                <input type="text" class="form-control" id="c_code" placeholder="Mã Giảm Giá" aria-label="Coupon Code" aria-describedby="button-addon2">
                                <div class="input-group-append">
                                    <button class="btn btn-primary btn-sm" type="button" id="button-addon2">Áp dụng</button>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
                
                    <div class="row mb-5">
                        <div class="col-md-12">
                            <h2 class="h3 mb-3 text-black">Danh sách sản phẩm</h2>
                            <div class="p-3 p-lg-5 border">
                                <table class="table site-block-order-table mb-5">
                                    <thead>
                                    <th>Sản phẩm</th>
                                    <th>Giá</th>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.CartItems)
                                        {
                                            <tr>
                                                <td>
                                                    
                                                    <input type="hidden" class="cart-item-id" name="CartID[@i]" value="@(item.MaGioHang)">
                                                    @(item.ChiTietSanPham?.DanhMucSp?.TenSp ?? "Không xác định")
                                                    -
                                                    @(item.ChiTietSanPham?.KichThuoc ?? "Không xác định")
                                                    -
                                                    @(item.ChiTietSanPham?.MauSac ?? "Không xác định")
                                                    x
                                                    @item.SoLuong
                                                </td>
                                                <td>
                                                    @((item.ChiTietSanPham?.DanhMucSp?.Gia ?? 0) * item.SoLuong)
                                                </td>
                                            </tr>
                                            i++;
                                        }
                                        <tr>
                                            <td class="text-black font-weight-bold"><strong>Tổng tiền</strong></td>
                                            <td class="text-black font-weight-bold"><strong>@Model.CartItems.Sum(item => (item.ChiTietSanPham?.DanhMucSp?.Gia ?? 0) * item.SoLuong)</strong></td>
                                        </tr>
                                    </tbody>
                                </table>

                                    <div class="border p-3 mb-3">
                                        <h3 class="h6 mb-0">Chọn phương thức thanh toán</h3>

                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" id="payment_cash" name="PhuongThucThanhToan" value="cash" checked>
                                            <label class="form-check-label" for="payment_cash">
                                                Thanh toán khi nhận hàng
                                            </label>
                                            <p class="text-muted ml-4">Bạn sẽ trả tiền khi nhận được hàng.</p>
                                        </div>

                                        <div class="form-check mt-3">
                                            <input class="form-check-input" type="radio" id="payment_online" name="PhuongThucThanhToan" value="online">
                                            <label class="form-check-label" for="payment_online">
                                                Thanh toán trực tuyến
                                            </label>
                                            <p class="text-muted ml-4">Bạn sẽ trả tiền qua mã QR được cung cấp.</p>
                                        </div>
                                    </div>

                                <div class="form-group">
                                        <button type="submit" id ="ajaxPaymentButton" class="btn btn-primary btn-lg py-3 btn-block">Thanh toán</button>
                                </div>

                            </div>
                        </div>
                    </div>
                
            </div>
        </div>
        </form>
    </div>
</div>

@section Scripts{
    <script>
        function loadProvinces(selectId, districtSelectId) {
            fetch('https://provinces.open-api.vn/api/p/')
                .then(response => response.json())
                .then(data => {
                    let provinceSelect = document.getElementById(selectId);
                    data.forEach(province => {
                        let option = document.createElement('option');
                        option.value = province.code;
                        option.textContent = province.name;
                        provinceSelect.appendChild(option);
                    });

                    provinceSelect.addEventListener('change', function () {
                        loadDistricts(provinceSelect.value, districtSelectId);
                    });
                });
        }

        function loadDistricts(provinceCode, districtSelectId) {
            fetch(`https://provinces.open-api.vn/api/p/${provinceCode}?depth=2`)
                .then(response => response.json())
                .then(data => {
                    let districtSelect = document.getElementById(districtSelectId);
                    districtSelect.innerHTML = '';
                    data.districts.forEach(district => {
                        let option = document.createElement('option');
                        option.value = district.code;
                        option.textContent = district.name;
                        districtSelect.appendChild(option);
                    });
                });
        }

        loadProvinces('c_country', 'c_district');
        loadProvinces('c_diff_country', 'c_diff_district');
        function updateProvinceName() {
            const provinceSelect = document.getElementById('c_diff_country');
            const provinceName = provinceSelect.options[provinceSelect.selectedIndex].text;
            document.getElementById('ten_thanh_pho').value = provinceName; 
        }

        function updateDistrictName() {
            const districtSelect = document.getElementById('c_diff_district');
            const districtName = districtSelect.options[districtSelect.selectedIndex].text;
            document.getElementById('ten_quan_huyen').value = districtName; 
        }       
    </script>
}