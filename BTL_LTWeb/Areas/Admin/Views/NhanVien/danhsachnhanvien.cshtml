@using X.PagedList.Mvc.Core;
@model X.PagedList.IPagedList<BTL_LTWeb.Models.TNhanVien>
@{
    ViewData["Title"] = "Danhsachnhanvien";
    Layout = "~/Areas/Admin/Views/Shared/_LayoutAdmin.cshtml";
}
@addTagHelper *, Microsoft.AspNetCore.Mvc.TagHelpers
<div class="row">
    <h1>Danh Sách Nhân viên</h1>
    <p>
        <a class="btn btn-info" asp-controller="NhanVien" asp-action="Themnhanvien">Thêm nhân viên</a>
    </p>
    <form id="searchForm" asp-controller="NhanVien" asp-action="TimNhanVien" method="get" class="site-block-top-search d-flex">
        <input type="text" id="TenNhanVien" name="TenNhanVien" class="form-control border-1" placeholder="Search">
        <button type="submit" class="btn btn-primary">Search</button>
    </form>
    <p></p>
    <div id="notification" style="display:none; padding: 10px; margin-bottom: 20px;"></div>
    <div class="alert alert-warning" id="staffList">
        @await Html.PartialAsync("_DanhSachNhanVienPartial", Model)
    </div>
</div>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        let timeout = null;
        $('#searchForm').submit(function (e) {
            e.preventDefault();
            var searchQuery = $('#TenNhanVien').val();
            if(searchQuery) {
                loadNhanVienList(1);
            }
            // else {
            //     loadNhanVienList(1);
            // }
            
        });
        $('#TenNhanVien').on('input', function () {
            clearTimeout(timeout); 
            timeout = setTimeout(function () { 
                var searchQuery = $('#TenNhanVien').val();
                if (!searchQuery) { loadNhanVienList(1); }
                
            }, 1000);
        });

        
        function loadNhanVienList(page) {
            var searchQuery = $('#TenNhanVien').val();

            $.ajax({
                url: '@Url.Action("Timnhanvien", "NhanVien")',
                type: 'GET',
                data: { TenNhanVien: searchQuery, page: page },
                success: function (result) {
                    console.log("Kết quả trả về từ server:", result);
                    let notification = $('#notification');
                    if (typeof result === 'string' && result.trim() === "") {
                        $('#staffList').html(result);
                        notification.text("Không tìm thấy nhân viên!").css({
                            "color": "red",
                            "display": "block",
                            "background-color": "#ffe6e6",
                            "border": "1px solid red"
                        });
                        setTimeout(function () {
                            notification.hide();
                        }, 3000);
                    }
                    else {
                        $('#staffList').html(result);
                        notification.hide();
                        
                    }  
                },
                error: function() {
                    $('#notification').text("Có lỗi xảy ra, vui lòng thử lại!").css({
                        "color": "red",
                        "display": "block",
                        "background-color": "#ffe6e6",
                        "border": "1px solid red"
                    });
                    setTimeout(function () {
                        notification.hide();
                    }, 3000);
                }
            });
        }
        $(document).on('click', '#staffList .pagination a', function (e) {
            e.preventDefault();
            // var page = $(this).attr('data-page');
            var href = $(this).attr('href');
            var page = href.split('page=')[1];
            loadNhanVienList(page);
        });
        $(document).on('click', '.edit-link', function (e) {
            e.preventDefault();
            var id = $(this).data('id'); 
            window.location.href = '@Url.Action("Suanhanvien", "NhanVien")' + '?MaNV=' + id;
        });
        $(document).on('click', '.delete-link', function (e) {
            e.preventDefault();
            var id = $(this).data('id'); 
            console.log("ID nhân viên cần xóa:", id);

            if (confirm("Bạn có chắc chắn muốn xóa nhân viên này không?")) { 
                $.ajax({
                    url: '@Url.Action("XoaNhanVien", "NhanVien")',
                    type: 'POST',
                    data: { MaNV: id },
                    success: function (result) {
                        console.log("Response từ server:", result);
                        let notification = $('#notification');
                        if (result.success) {
                            notification.text("Xóa nhân viên thành công!").css({
                                "color": "green",
                                "display": "block",
                                "background-color": "#e6ffe6",
                                "border": "1px solid green"
                            });
                            loadNhanVienList(1);
                        } else {
                            notification.text("Lỗi: " + result.message).css({
                                "color": "red",
                                "display": "block",
                                "background-color": "#ffe6e6",
                                "border": "1px solid red"
                            });
                        }
                        setTimeout(function () {
                            notification.hide();
                        }, 20000);
                    },
                    error: function () {
                        $('#notification').text("Có lỗi xảy ra khi xóa nhân viên.").css({
                            "color": "red",
                            "display": "block",
                            "background-color": "#ffe6e6",
                            "border": "1px solid red"
                        });
                        setTimeout(function () {
                            notification.hide();
                        }, 3000);
                    }
                });
            }
        });
    });
</script>